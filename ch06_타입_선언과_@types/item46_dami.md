# 아이템 46. 타입 선언과 관련된 세 가지 버전 이해하기

타입스크립트를 사용하면 아래 세가지 사항을 고려해야 하기에 의존성 관리를 더 복잡하게 만듭니다.

- 라이브러리의 버전
- 타입 선언(@types)의 버전
- 타입스크립트의 버전

세 가지 버전 중 하나라도 맞지 않으면, 의존성과 상관없어 보이는 곳에서 오류가 발생할 수 있습니다.
타입스크립트에서 의존성을 사용하기 위해 특정 라이브러리를 dependencies로 설치하고, 타입 정보는 devDependencies로 설치합니다. (아이템 45)

```typescript
$ npm install react
+ react@16.8.6

$ npm install --save-dev @types/react
+  @types/react@16.8.19
```

위 예제에서는 메이저 버전과 마이너 버전(16.8)이 일치하지만 패치 버전(.6 vs .19)은 일치하지 않습니다.
`@types/react@16.8.19` 는 타입 선언들이 리액트 16.8 버전의 API를 나타낸다는 것을 의미합니다.

리액트 모듈이 시맨틱(semantic) 버전 규칙을 제대로 지킨다고 했을때, 패치 버전들(16.8.1, 16.8.2...)의 경우 공개 API의 사양을 변경하지 않기에 타입 선언을 업데이트할 필요가 없습니다. 그러나 타입 선언 자체도 버그, 누락이 존재할 수 있습니다.

> MAJPR.MINOR.PATCH
>
> - MAJOR: API 호환성이 깨질만한 변경사항
>
> - MINOR: 하위 호환성 지키면서 API 기능이 추가된 것
>
> - PATCH: 하위 호환성 지키는 범위 내에서 버그가 수정된 것

@types 모듈의 패치 버전은 버그나 누락으로 인한 수정, 추가에 따른 것입니다.

## 타입 정보 버전이 별도로 관리되는 것의 4가지 문제점

### 1. 라이브러리는 업데이트했지만 타입 선언은 업데이트 하지 않은 경우

- 라이브러리 업데이트와 관련된 새로운 기능을 사용하려 할 때마다 타입 오류가 발생합니다.
- 하위 호환성이 깨지는 변경이 있다면, 타입 체커는 통과해도 런타임에 오류가 발생할 수 있습니다.

#### 해결책

1. 타입 선언도 라이브러리 버전에 맞게 업데이트 한다.
2. 사용하려는 새 함수와 메서드의 타입 정보를 프로젝트 자체에 추가한다.
3. 타입 선언 업데이트를 직접 작성해서 커뮤니티에 기여한다.

### 2. 라이브러리보다 타입 선언의 버전이 최신인 경우

보통 타입 없이 라이브러리를 상용하다가 타입 선언을 설치하려고 할 때 발생합니다.

타입 체커는 최신 API를 기준으로 코드를 검사하게 되지만 런타임에 실제로 쓰이는 것은 과거 버전입니다.

#### 해결책

라이브러리와 타입 선언 버전이 맞도록

1. 라이브러리 버전을 올린다.
2. 타입 버전을 내린다.

### 3. 프로젝트 타입스크립트 버전보다 라이브러리 타입스크립트 버전이 최신인 경우

현재 프로젝트보다 라이브러리에게 필요한 타입스크립트 버전이 높은 상황이라면, @types 선언 자체에서 타입오류가 발생하게 됩니다.

#### 해결책

1. 라이브러리 타입 선언의 버전을 원래대로 내린다.
2. declare module을 선언해서 라이브러리의 타입 정보를 없앤다

### 4. @types 의존성이 중복되는 경우

@types/foo이 @types/bar에 의존한다면, npm은 중첩된 폴더에 별도로 해당 버전을 설치해 문제를 해결하려 할 것입니다.

```
node_modules/
  @types/
    foo/
      index.d.ts @1.2.3
    bar/
      index.d.ts
      node_modules/
        @types/
          foo/
            index.d.ts @2.3.4
```

런타입에 사용되는 모듈이 아니라 전역 네임스페이스(name-space)에 있는 타입 선언 모듈이라면 중복된 선언, 선언이 병합될 수 없다는 오류로 나타나게 됩니다.

#### 해결책

npm ls @types/foo 를 실행해서 어디서 타입 선언이 중복으로 발생했는지 추적한 뒤

1. @types/foo를 업데이트 하거나, @types/bar를 업데이트해서 서로 호환되게 한다.

## 번들된 타입이 문제가 되는 상황

### 1. 번들된 타입에서는 @types 버전 선택이 불가능

### 2. 프로젝트 내 타입 선언이 다른 라이브러리의 타입 선언에 의존한 경우

- 작성자가 의존성을 devDpendencies로 한 경우 다른 사용자가 설치했을 때 devDpendencies 내용은 설치 되지가 않아 타입 오류가 발생하게 됩니다.

### 3. 프로젝트의 과거 버전에 있는 타입 선언에 문제가 있는 경우

- 이 경우엔 과거 버전으로 돌아가서 패치 업데이트를 해야합니다.

### 4. 타입 선언의 패치 업데이트를 자주하기 어렵다.

- 라이브러리 자체보다 타입 선언에 대한 패치 업데이트가 세 배나 더 많았고, 이 패치 업데이트를 자주하기 어렵습니다.

## 결론

- @types 의존성과 관련된 3가지 버전이 있다.
  - 라이브러리 버전
  - @types 버전
  - 타입스크립트 버전
- 라이브러리를 업데이트 하는 경우 해당 @types 역시 업데이트 해야한다.
- 타입스크립트로 작성된 라이브러리 -> 타입 선언을 자체적으로 포함하자.
- 자바스크립트로 작성된 라이브러리 -> 타입 선언을 DefinitelyTyped에 공개하자.
